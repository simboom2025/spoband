<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPOBAND Pro | 신청자 목록</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif; }
    .container-narrow{ max-width: 1100px; }
  </style>
</head>
<body class="bg-slate-900 text-white">
<header class="sticky top-0 z-40 bg-slate-950/80 border-b border-slate-800 backdrop-blur">
  <div class="container-narrow mx-auto px-4 h-14 flex items-center justify-between">
    <a href="index.html" class="font-extrabold">SPOBAND <span class="text-sky-400">Pro</span></a>
    <nav class="flex gap-3 text-sm">
      <a href="index.html#apply" class="px-3 py-1 rounded-lg bg-sky-600 hover:bg-sky-500 text-white">신청 등록</a>
      <a href="admin.html" class="px-3 py-1 rounded-lg bg-slate-700 hover:bg-slate-600">관리자</a>
    </nav>
  </div>
</header>

<main class="container-narrow mx-auto px-4 py-8">
  <h1 class="text-2xl md:text-3xl font-extrabold">제출 후 신청목록 보기</h1>
  <p class="mt-1 text-slate-300 text-sm">“상세보기”를 누르고 <b>신청 비번(ID)</b>을 입력하면 상세가 열립니다.</p>

  <div id="boardList" class="mt-6 flex flex-col gap-4"></div>
</main>

<script>
/* ====== 설정 ====== */
const API_URL = "여기에_웹앱_URL_붙여넣기";  // <-- 같은 URL을 index.html에도 사용
const PLAIN_HEADERS = { 'Content-Type': 'text/plain;charset=utf-8' };

/* ====== DOM 헬퍼 ====== */
const $  = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));

/* ====== 포맷/마스킹 ====== */
const esc=(s)=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
const fmt=(ts)=>{ const d=new Date(Number(ts)); return isNaN(d.getTime())?'날짜 정보 없음':d.toLocaleString('ko-KR'); };
function maskName(name=""){ const s=String(name).trim(); if(s.length<=1) return s; if(s.length===2) return s[0]+'*'; return s[0]+'*'.repeat(s.length-2)+s[s.length-1]; }
const maskDojo = maskName;
function maskContact(raw=""){
  const digits=String(raw).replace(/\D/g,'');
  if(digits.length>7) return `${digits.slice(0,3)}-****-${digits.slice(-4)}`;
  if(String(raw).includes('@')){ const [a,b]=String(raw).split('@'); return `${a.slice(0,3)}***@${b}`;}
  return "***-****-****";
}

/* ====== JSON 파싱 + 상태 체크 ====== */
async function parseJson(res){
  const text=await res.text();
  let json; try{ json=JSON.parse(text); } catch{ throw new Error('API 응답 형식 오류'); }
  if(!res.ok || json.status==='error') throw new Error(json.message||`HTTP ${res.status}`);
  return json;
}

/* ====== 정규화 ====== */
function normalizeItems(raw = {}) {
  const items = raw.items || {};
  return {
    sb30:+(items.sb30??raw.sb30??0)||0,
    sb35:+(items.sb35??raw.sb35??0)||0,
    sb45:+(items.sb45??raw.sb45??0)||0,
    sb55:+(items.sb55??raw.sb55??0)||0,
    sb65:+(items.sb65??raw.sb65??0)||0
  };
}
function computeTotalCount(items){ return Object.values(items).reduce((a,b)=>a+(+b||0),0); }
function normalizePost(raw = {}) {
  const items = normalizeItems(raw);
  return {
    id: String(raw.id ?? raw._id ?? ''),
    dojo: String(raw.dojo ?? ''),
    master: String(raw.master ?? ''),
    contact: String(raw.contact ?? ''),
    address: String(raw.address ?? ''),
    ts: raw.ts ?? '',
    items, totalCount: computeTotalCount(items),
    status: raw.status || '신규',
    replies: Array.isArray(raw.replies) ? raw.replies : [],
    quotationUrl: raw.quotationUrl || ''
  };
}
function normalizeListResponse(data){
  const arr = Array.isArray(data)?data:(data.items||data.data||[]);
  return arr.map(normalizePost);
}

/* ====== API ====== */
async function loadApplications() {
  try {
    const r1 = await fetch(API_URL,{ method:'POST', headers:PLAIN_HEADERS, body: JSON.stringify({ action:'publicList' })});
    const j1 = await parseJson(r1);
    const arr1 = Array.isArray(j1) ? j1 : (j1.items || j1.data || []);
    if (Array.isArray(arr1)) return normalizeListResponse(arr1);
  } catch(e){ console.warn('[publicList] POST 실패, GET 폴백:', e); }
  const r2 = await fetch(API_URL+'?action=list', { method:'GET', cache:'no-cache' });
  const j2 = await parseJson(r2);
  const arr2 = Array.isArray(j2) ? j2 : (j2.items || j2.data || []);
  return normalizeListResponse(arr2);
}

async function fetchPostDetails(id, pw) {
  const res = await fetch(API_URL, {
    method:'POST', headers:PLAIN_HEADERS,
    body: JSON.stringify({ action:'getPost', id, pw })
  });
  const json = await parseJson(res);
  return normalizePost(json.data || json);
}

async function addUserReply(id, pw, content){
  const res = await fetch(API_URL, {
    method:'POST', headers: PLAIN_HEADERS,
    body: JSON.stringify({ action:'addUserReply', id, pw, content })
  });
  return parseJson(res);
}

/* ====== 상태 ====== */
let posts = [];
const pwCache = {};  // { [id]: pw }

/* ====== 렌더링 ====== */
function render(){
  const list=$("#boardList");
  if(!posts.length){
    list.innerHTML = '<p class="text-slate-400 text-sm p-4 text-center">아직 등록된 신청이 없습니다.</p>';
    return;
  }
  list.innerHTML = posts.map(p=>`
    <article class="p-4 rounded-xl bg-slate-800/60 border border-slate-700" data-id="${esc(p.id)}">
      <div class="flex flex-col md:flex-row justify-between gap-3">
        <div>
          <div class="font-bold text-lg">${esc(maskDojo(p.dojo))}</div>
          <div class="text-slate-300">관장님: ${esc(maskName(p.master))}</div>
          <div class="text-slate-400 text-sm">연락처: ${esc(maskContact(p.contact))}</div>
          <div class="text-xs text-slate-500 mt-1">${fmt(p.ts)}</div>
        </div>
        <div class="flex items-center gap-2">
          <span class="px-2 py-1 rounded-full text-xs bg-slate-700">${esc(p.status||'신규')}</span>
          <button class="view-details px-3 py-1.5 rounded-lg bg-sky-600 hover:bg-sky-500 text-white text-sm">상세보기</button>
        </div>
      </div>
      <div id="details-${esc(p.id)}" class="hidden p-3 mt-3 rounded-lg bg-slate-900/40 border border-slate-800">
        <p class="text-center text-slate-400 p-4">상세 정보를 불러오는 중...</p>
      </div>
    </article>
  `).join("");

  $$(".view-details").forEach(b=>b.addEventListener("click", onView));
}

function renderPostDetails(container, d){
  const itemsLines = Object.entries(d.items||{})
    .filter(([,v])=>(+v||0)>0)
    .map(([k,v])=>{
      const m={sb30:'SB30',sb35:'SB35',sb45:'SB45',sb55:'SB55',sb65:'SB65'};
      return `${m[k]||k} ${v}`;
    }).join(' / ') || '-';

  const repliesHTML=(d.replies||[]).map(r=>`
    <div class="mt-1 p-2 rounded bg-slate-800/40 border border-slate-700/50">
      <div class="text-xs text-slate-400">[${fmt(r.ts)}] ${r.author==='admin'?'관리자':'신청자'}</div>
      <div class="whitespace-pre-wrap">${esc(r.content||'')}</div>
    </div>`).join('');

  const quoteHTML=d.quotationUrl
    ? `<a class="text-sky-300 underline" target="_blank" href="${esc(d.quotationUrl)}">열기</a>`
    : '없음';

  const noteBoxId = `note-${d.id}`;

  container.innerHTML = `
    <div class="text-sm">
      <div class="text-slate-300"><b>도장명</b> · ${esc(d.dojo||'-')}</div>
      <div class="text-slate-300"><b>관장명</b> · ${esc(d.master||'-')}</div>
      <div class="text-slate-400"><b>연락처</b> · ${esc(d.contact||'-')}</div>
      <div class="text-slate-400"><b>주소</b> · ${esc(d.address||'-')}</div>
      <div class="mt-1"><span class="px-2 py-0.5 text-xs rounded bg-slate-700">${esc(d.status||'신규')}</span></div>
    </div>
    <hr class="my-3 border-slate-800">
    <div class="text-sm"><b>항목</b>: ${itemsLines} (합계 ${d.totalCount})</div>
    <div class="mt-2 text-sm"><b>견적서</b>: ${quoteHTML}</div>

    ${repliesHTML?`<div class="mt-3"><div class="text-xs text-slate-400 mb-1">관리자/신청자 대화</div>${repliesHTML}</div>`:''}

    <div class="mt-3 p-3 rounded-lg bg-slate-800/30 border border-slate-700/50">
      <div class="text-xs text-slate-400 mb-1">내 추가 메모/문의</div>
      <textarea id="${noteBoxId}" rows="2"
        class="w-full px-3 py-2 rounded-lg bg-slate-900/60 border border-slate-700 focus:ring-2 focus:ring-sky-500"
        placeholder="예) 견적서 잘 받았습니다. 배송일 문의 드립니다."></textarea>
      <div class="mt-2 text-right">
        <button class="btn-send px-3 py-1.5 rounded-lg bg-sky-600 hover:bg-sky-500 text-white text-sm">등록</button>
      </div>
    </div>

    <button class="btn-close mt-3 px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">닫기</button>
  `;

  // 등록
  container.querySelector('.btn-send')?.addEventListener('click', async ()=>{
    const ta = container.querySelector(`#${CSS.escape(noteBoxId)}`);
    const content = (ta?.value || '').trim();
    if(!content){ alert('내용을 입력해주세요.'); return; }
    try{
      await addUserReply(d.id, pwCache[d.id], content);
      ta.value = '';
      const fresh = await fetchPostDetails(d.id, pwCache[d.id]);
      renderPostDetails(container, fresh);
    }catch(err){ alert(err.message || '등록에 실패했습니다.'); }
  });

  container.querySelector('.btn-close')?.addEventListener('click', ()=>{
    container.classList.add('hidden');
    container.innerHTML = `<p class="text-center text-slate-400 p-4">상세 정보를 불러오는 중...</p>`;
  });
}

/* ====== 이벤트 ====== */
async function onView(e){
  const article=e.currentTarget.closest("article");
  const id=String(article.dataset.id);
  const detailsContainer=$(`#details-${CSS.escape(id)}`) || article.querySelector(`#details-${CSS.escape(id)}`);
  if(!detailsContainer) return;

  const pw=prompt("작성 시 설정한 비밀번호(=신청 비번)를 입력하세요.");
  if(pw===null) return;
  pwCache[id]=pw;

  detailsContainer.classList.remove("hidden");
  detailsContainer.scrollIntoView({behavior:"smooth",block:"center"});

  try{
    const d=await fetchPostDetails(id,pw);
    renderPostDetails(detailsContainer,d);
  }catch(err){
    alert(err.message||'정보를 불러올 수 없습니다.');
    detailsContainer.classList.add('hidden');
  }
}

/* ====== 초기 로드 ====== */
document.addEventListener('DOMContentLoaded', async ()=>{
  try{ posts = await loadApplications(); }
  catch(e){
    $("#boardList").innerHTML = `<p class="text-slate-300 p-4 border border-red-500/30 bg-red-900/20 rounded-lg">${esc(e.message||'불러오기 실패')}</p>`;
  }
  render();
});
</script>
</body>
</html>
