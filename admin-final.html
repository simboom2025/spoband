<!DOCTYPE html>
<html lang="ko">
<head>
    <title>SPOBAND Admin</title>
    <style>
        body { font-family: sans-serif; background-color: #111827; color: #e5e7eb; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #374151; }
        thead { background-color: #1f2937; }
        select, button { padding: 6px; border-radius: 4px; border: 1px solid #4b5563; background-color: #374151; color: #e5e7eb; cursor: pointer; }
        .delete-btn { background-color: #dc2626; color: white; }
        a { color: #38bdf8; text-decoration: none; }
    </style>
</head>
<body>

    <table>
        <thead>
            <tr>
                <th>신청비번</th>
                <th>신청일</th>
                <th>도장명</th>
                <th>관장명</th>
                <th>연락처</th>
                <th>신청항목</th>
                <th>답변</th>
                <th>견적서</th>
                <th>주소</th>
                <th>최종상태</th>
                <th>비고</th>
                <th>작업</th>
            </tr>
        </thead>
        <tbody id="application-list">
            </tbody>
    </table>

<script>
// --- 데이터 렌더링 함수 ---
// 이 함수가 백엔드에서 받은 데이터를 기반으로 테이블 내용을 그립니다.
function renderApplications(applications) {
    const tbody = document.getElementById('application-list');
    tbody.innerHTML = ''; // 기존 내용을 초기화합니다.

    // 각 신청 건에 대해 반복하며 테이블 행(tr)을 생성합니다.
    applications.forEach(app => {
        const tr = document.createElement('tr');

        // 각 행에 들어갈 HTML 내용을 정의합니다.
        // 여기에 누락되었던 `formatDate(app.ts)` (신청일)을 추가하여 밀림 현상을 해결했습니다.
        tr.innerHTML = `
            <td>${app.id || ''}</td>
            <td>${formatDate(app.ts)}</td>
            <td>${app.dojo || ''}</td>
            <td>${app.master || ''}</td>
            <td>${app.contact || ''}</td>
            <td>${formatItems(app.items)}</td>
            <td>${formatReplies(app.replies)}</td>
            <td>${app.quotationUrl ? `<a href="${app.quotationUrl}" target="_blank">보기</a>` : '없음'}</td>
            <td>${app.address || ''}</td>
            <td>
                <select data-id="${app.id}">
                    ${generateStatusOptions(app.status)}
                </select>
            </td>
            <td>${app.notes || ''}</td>
            <td><button class="delete-btn" data-id="${app.id}">삭제</button></td>
        `;
        tbody.appendChild(tr);
    });
}


// --- 헬퍼(Helper) 함수들 ---
// 데이터를 화면에 예쁘게 표시하기 위한 보조 함수들입니다.

// 1. 날짜 형식 변환 (예: 1695123456789 -> '2025. 09. 19. 20:37')
function formatDate(timestamp) {
    if (!timestamp) return '날짜 없음';
    const d = new Date(timestamp);
    const YYYY = d.getFullYear();
    const MM = String(d.getMonth() + 1).padStart(2, '0');
    const DD = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${YYYY}. ${MM}. ${DD}. ${hh}:${mm}`;
}

// 2. 신청 항목 객체를 HTML 문자열로 변환
function formatItems(items) {
    if (!items || typeof items !== 'object') return '';
    // 예: {sb30: 50, sb65: 90} -> "sb30: 50개<br>sb65: 90개<br>합계: 140개"
    let total = 0;
    const itemEntries = Object.entries(items).map(([key, value]) => {
        const numValue = parseInt(value, 10) || 0;
        total += numValue;
        return `${key}: ${numValue}개`;
    });
    return `${itemEntries.join('<br>')}<br><b>합계: ${total}개</b>`;
}

// 3. 답변 배열을 HTML 문자열로 변환
function formatReplies(replies) {
    if (!Array.isArray(replies) || replies.length === 0) return '';
    // 예: [{ts: ..., content: "첫 번째 답변"}, ...] -> "[2025.09.19] 첫 번째 답변<br>..."
    return replies.map(reply => {
        const d = new Date(reply.ts);
        const dateStr = `[${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}]`;
        return `${dateStr} ${reply.content}`;
    }).join('<br>');
}

// 4. 최종상태 드롭다운(<select>) 메뉴 생성
function generateStatusOptions(currentStatus) {
    const statuses = ['신규', '확인', '배송준비', '배송완료', '보류'];
    return statuses.map(status =>
        `<option value="${status}" ${status === currentStatus ? 'selected' : ''}>${status}</option>`
    ).join('');
}


// --- 테스트용 예시 데이터 ---
// 실제로는 fetch를 통해 이와 같은 형식의 데이터를 받아옵니다.
const mockData = [
    {
        id: '1234',
        ts: 1758259342000, // 2025년 9월 19일 오후 10:22
        dojo: '서대문태권도',
        master: '정관식',
        contact: '010-9796-1234',
        items: { sb30: 50, sb65: 90 },
        replies: [{ ts: 1758259342000, content: "첫 번째 답변입니다." }],
        quotationUrl: '',
        address: '서울 서대문구 북가좌동 321',
        status: '신규',
        notes: ''
    }
];

// 페이지 로드 시 예시 데이터로 테이블을 그립니다.
// 실제 코드에서는 fetch 성공 후 받은 데이터로 이 함수를 호출해야 합니다.
renderApplications(mockData);

</script>

</body>
</html>