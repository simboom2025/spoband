<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SPOBAND Admin (Final)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
  .container-fluid{width:98%; margin: 0 auto;}
  .grid-wrap{border-radius:16px;overflow:auto;border:1px solid #1f2937;background:#0f172a; height: calc(100vh - 150px);}
  table.grid{width:100%;border-collapse:separate;border-spacing:0;min-width:2000px}
  .grid thead th{
    position:sticky;top:0;z-index:1;background:#0b1220;color:#cbd5e1;font-weight:700;
    border-bottom:1px solid #1f2937; padding:10px 12px; text-align:left; white-space:nowrap; cursor: pointer;
  }
  .grid thead th:hover { background: #1e2b3b; }
  .grid tbody td{padding:8px 12px;border-bottom:1px solid #1f2937;color:#e2e8f0; vertical-align: top; font-size: 13px;}
  .grid tbody tr:nth-child(even){background:#0b1220}
  .grid tbody tr:hover{background:#122137}
  .td-pre { 
    font-family: monospace; white-space: pre-wrap; max-width: 300px;
    min-width:200px; box-sizing: border-box; line-height: 1.4;
  }
  .status-select {
    background-color: #1f2937; color: #cbd5e1; border: 1px solid #334155;
    border-radius: 8px; padding: 4px 8px; font-size: 12px;
  }
  .loading-overlay {
    position: fixed; inset: 0; background: rgba(2,6,23,.5); backdrop-filter: blur(1px);
    display: none; align-items: center; justify-content: center; z-index: 60; color: white; font-size: 1.2rem;
  }
  .loading-overlay.show { display: flex; }
</style>
</head>
<body class="bg-slate-900 text-white">

<div id="loading" class="loading-overlay"><span>처리 중...</span></div>

<header class="sticky top-0 z-40 bg-slate-950/70 border-b border-slate-800 backdrop-blur">
  <div class="container-fluid mx-auto h-16 px-4 flex items-center justify-between">
    <h1 class="text-xl font-black">SPOBAND <span class="text-sky-400">Admin</span> <span class="text-sm font-normal text-slate-400">Final Ver.</span></h1>
    <div class="flex items-center gap-3">
      <button id="btnReload" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded">새로고침</button>
      <button id="btnLogout" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded">로그아웃</button>
    </div>
  </div>
</header>

<main class="container-fluid mx-auto px-4 py-6">
  <div class="grid-wrap">
    <table class="grid" id="grid">
      <thead>
        <tr>
          <th class="sortable" data-sort="pw">신청비번</th>
          <th class="sortable" data-sort="ts">신청일</th>
          <th class="sortable" data-sort="dojo">도장명</th>
          <th class="sortable" data-sort="master">관장명</th>
          <th class="sortable" data-sort="contact">연락처</th>
          <th>신청항목</th>
          <th>답변</th>
          <th>견적서</th>
          <th class="sortable" data-sort="address">주소</th>
          <th class="sortable" data-sort="status">최종상태</th>
          <th class="sortable" data-sort="notes">비고</th>
          <th style="width:100px">작업</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbw5_Q2KXlG5EhJiqjfv3SDfutRU6-_DnYmJmwqte_SS2H30-nQMVBcM4KHqbHevblwj/exec"; // ❗❗❗ 새 버전으로 재배포한 새 URL로 꼭 교체해주세요 ❗❗❗
const ADMIN_SECRET = localStorage.getItem("ADMIN_SECRET") || "";
let POSTS = [];
let sortState = { key: 'ts', asc: false }; // Default sort by date descending
const STATUS_OPTIONS = ["신규", "배송준비", "배송중", "배송완료", "반품"];

/* ============= UTILS ================== */
const $ = (s, el = document) => el.querySelector(s);
const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));
const fmt = ts => ts ? new Date(ts).toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : "";
const esc = s => String(s || "").replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c]));
const showLoading = () => $("#loading").classList.add("show");
const hideLoading = () => $("#loading").classList.remove("show");
function alertErr(e) { hideLoading(); alert("오류: " + (e?.message || e)); }

/* ============= CUSTOM FORMATTERS ============= */
function formatItems(items) {
    if (!items || typeof items !== 'object' || Object.keys(items).length === 0) return '';
    if (items.error) return items.error;
    return Object.entries(items)
        .map(([key, value]) => `${esc(key)}: ${esc(value)}개`)
        .join('\n');
}

function formatReplies(replies) {
    if (!replies || !Array.isArray(replies) || replies.length === 0) return '';
    return replies.map(reply => `[${fmt(reply.ts)}] ${esc(reply.content)}`)
        .join('\n\n');
}

/* ============= DATA & RENDER ============= */
async function apiCall(payload) {
    showLoading();
    try {
        const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ ...payload, secret: ADMIN_SECRET })
        });
        const json = await res.json();
        if (!res.ok || json.status !== "success") throw new Error(json.message || `HTTP ${res.status}`);
        return json;
    } finally {
        hideLoading();
    }
}

async function fetchList() {
    showLoading();
    try {
        const res = await fetch(`${API_URL}?action=list`);
        if (!res.ok) throw new Error("목록 불러오기 실패 (HTTP " + res.status + ")");
        POSTS = await res.json();
        sortData(sortState.key, false);
    } catch (e) {
        alertErr(e);
    } finally {
        hideLoading();
    }
}

function sortData(key, toggle = true) {
    if (toggle) {
        if (sortState.key === key) sortState.asc = !sortState.asc;
        else { sortState.key = key; sortState.asc = true; }
    }
    POSTS.sort((a, b) => {
        let valA = a[key] || '';
        let valB = b[key] || '';
        if (key === 'pw') { valA = Number(valA); valB = Number(valB); }
        if (valA < valB) return sortState.asc ? -1 : 1;
        if (valA > valB) return sortState.asc ? 1 : -1;
        return 0;
    });
    renderGrid();
}

function renderGrid() {
    $("#tbody").innerHTML = POSTS.map(r => `
    <tr>
      <td>${esc(r.pw)}</td>
      <td><span class="whitespace-nowrap">${fmt(r.ts)}</span></td>
      <td>${esc(r.dojo)}</td>
      <td>${esc(r.master)}</td>
      <td>${esc(r.contact)}</td>
      <td><pre class="td-pre">${formatItems(r.items)}</pre></td>
      <td><pre class="td-pre">${formatReplies(r.replies)}</pre></td>
      <td>
        ${r.quotationUrl ? `<a href="${esc(r.quotationUrl)}" target="_blank" class="text-sky-400 underline hover:text-sky-300">다운로드</a>` : `<span class="text-slate-500">없음</span>`}
      </td>
      <td>${esc(r.address)}</td>
      <td>
        <select class="status-select" data-id="${r.id}" onchange="onStatusChange(this)">
          ${STATUS_OPTIONS.map(opt => `<option value="${opt}" ${r.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
        </select>
      </td>
      <td>${esc(r.notes)}</td>
      <td>
        <button class="text-xs bg-red-600 hover:bg-red-700 text-white py-1 px-2 rounded" onclick="onDelete('${r.id}')">삭제</button>
      </td>
    </tr>
  `).join("");
}

/* ============= ACTIONS ============= */
async function onStatusChange(selectElement) {
    const id = selectElement.dataset.id;
    const newStatus = selectElement.value;
    try {
        await apiCall({ action: "updateStatus", id, status: newStatus });
        const post = POSTS.find(p => p.id == id);
        if (post) post.status = newStatus;
    } catch(e) {
        alertErr(e);
        fetchList(); // Revert on error
    }
}

async function onDelete(id) {
    if (!confirm(`신청비번 ${id} 항목을 정말 삭제하시겠습니까?`)) return;
    try {
        await apiCall({ action: "delete", id });
        fetchList();
    } catch (e) { alertErr(e); }
}

/* ============= EVENT BINDING & INITIAL LOAD ============= */
document.addEventListener('DOMContentLoaded', () => {
    $("#btnReload").addEventListener("click", fetchList);
    $("#btnLogout").addEventListener("click", () => {
        if (confirm("로그아웃 하시겠습니까?")) {
            localStorage.removeItem("ADMIN_SECRET");
            alert("로그아웃 되었습니다. 페이지를 새로고침합니다.");
            location.reload();
        }
    });
    
    $$(".sortable").forEach(th => th.addEventListener("click", () => sortData(th.dataset.sort)));
    
    if (!ADMIN_SECRET) {
        const secret = prompt("관리자 비밀키를 입력하세요:");
        if (secret) {
            localStorage.setItem("ADMIN_SECRET", secret);
            location.reload();
        } else {
            document.body.innerHTML = `<div class="text-center p-8">관리자 키가 없어 페이지를 표시할 수 없습니다.</div>`;
        }
    } else {
        fetchList().catch(alertErr);
    }
});
</script>
</body>
</html>