<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SPOBAND Admin Dashboard Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root { --color-bg:#0d1117; --color-bg-secondary:#161b22; --color-bg-tertiary:#21262d; --color-border:#30363d; --color-text-primary:#c9d1d9; --color-text-secondary:#8b949e; --color-accent:#58a6ff; --color-danger:#f85149; }
  body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color:var(--color-bg); color:var(--color-text-primary); }
  .table-container{ margin-top:1.25rem; border-radius:.5rem; overflow:auto; border:1px solid var(--color-border); background:var(--color-bg-secondary); min-height:calc(100vh - 14.5rem); box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
  .table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  .table thead{ position:sticky; top:0; z-index:10; background:#1a202a; border-bottom:2px solid var(--color-border); }
  .table th,.table td{ padding:.8rem 1rem; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; vertical-align:middle; }
  .table th{ font-weight:600; font-size:.75rem; text-transform:uppercase; letter-spacing:.05em; }
  .table td{ font-size:.875rem; border-bottom:1px solid var(--color-border); }
  .table tbody tr:last-child td{ border-bottom:none; }
  .table tbody tr{ transition:background-color .2s; }
  .table tbody tr:nth-child(even){ background:rgba(255,255,255,.02); }
  .table tbody tr:hover{ background:var(--color-bg-tertiary); cursor:pointer; }
  .status-badge{ padding:.2rem .6rem; border-radius:9999px; font-size:.75rem; font-weight:600; display:inline-flex; align-items:center; gap:.35rem; color:var(--color-text-secondary); }
  .status-dot{ width:7px; height:7px; border-radius:50%; }
  .overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,.7); z-index:50; opacity:0; visibility:hidden; transition:opacity .3s, visibility .3s; }
  .overlay.show{ opacity:1; visibility:visible; }
  .overlay .modal-content-wrapper{ transform:scale(.95); transition:transform .3s; }
  .overlay.show .modal-content-wrapper{ transform:scale(1); }
  .tab-btn{ padding:.5rem .9rem; border:1px solid var(--color-border); border-radius:.6rem; background:var(--color-bg-tertiary); }
  .tab-btn.active{ background:#0ea5e9; border-color:#0ea5e9; color:#fff; font-weight:700; }
  @media (max-width:1024px){
    .table thead{ display:none; }
    .table tbody,.table tr,.table td{ display:block; }
    .table tr{ border:1px solid var(--color-border); border-radius:.5rem; margin-bottom:1rem; padding:.5rem; background:var(--color-bg-tertiary); }
    .table td{ text-align:right; padding-left:50%; position:relative; white-space:normal; border-bottom:1px dotted var(--color-border); min-height:2.5rem; display:flex; align-items:center; justify-content:flex-end; }
    .table td:last-child{ border-bottom:none; }
    .table td::before{ content:attr(data-label); position:absolute; left:1rem; font-weight:600; color:var(--color-text-secondary); text-align:left; }
    .table td.text-center,.table td.text-center::before{ text-align:left; justify-content:flex-start; }
    .table td.text-center::before{ content:''; }
    .table td.text-center .sel{ margin-left:1rem; }
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading" class="overlay">
  <div class="bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3">
    <svg class="animate-spin h-5 w-5 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
    <span id="loading-text">처리 중...</span>
  </div>
</div>

<!-- Login -->
<div id="login-wall" class="overlay show">
  <div class="w-full max-w-sm p-8 bg-slate-800 rounded-2xl shadow-lg border border-slate-700 modal-content-wrapper">
    <h2 class="text-2xl font-bold text-center text-sky-400 mb-2">SPOBAND Admin</h2>
    <p class="text-center text-slate-400 mb-6">관리자 비밀키를 입력하세요.</p>
    <form id="login-form">
      <input id="password-input" type="password" placeholder="비밀키 입력" class="w-full px-4 py-2 mb-4 bg-slate-900 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 transition">
      <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-sky-600 rounded-lg hover:bg-sky-700 transition-colors">로그인</button>
      <p id="login-error" class="text-red-400 text-center mt-4 h-4"></p>
    </form>
  </div>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="overlay">
  <div id="modal-backdrop" class="absolute inset-0"></div>
  <div class="relative bg-slate-800 rounded-lg shadow-xl w-full max-w-4xl border border-slate-700 max-h-[90vh] flex flex-col modal-content-wrapper">
    <div class="flex items-center justify-between p-4 border-b border-slate-700">
      <h3 class="text-lg font-bold text-sky-400">신청 상세 정보</h3>
      <button id="modal-close-btn" class="text-2xl text-slate-400 hover:text-white transition-colors">&times;</button>
    </div>
    <div id="modal-content" class="p-6 overflow-y-auto"></div>
    <div id="modal-actions" class="p-4 bg-slate-900/50 border-t border-slate-700 mt-auto"></div>
  </div>
</div>

<!-- Main -->
<div id="app-container" class="hidden">
  <header class="sticky top-0 z-40 bg-slate-950/80 border-b border-slate-800 backdrop-blur-lg shadow-sm">
    <div class="container mx-auto h-16 px-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">SPOBAND <span class="text-sky-400">Admin Pro</span></h1>
      <div class="flex items-center gap-3">
        <button id="btnDataTab" class="tab-btn active">신청관리</button>
        <button id="btnStatsTab" class="tab-btn">통계</button>
        <button id="btnReload" class="px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 transition-colors">새로고침</button>
        <button id="btnLogout" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors">로그아웃</button>
      </div>
    </div>
  </header>

  <!-- DATA TAB -->
  <main id="dataTab" class="container mx-auto px-4 py-4">
    <div id="errorMsg" class="text-red-400 mb-4 p-3 bg-red-900/20 border border-red-800 rounded-lg hidden"></div>

    <div class="toolbar flex flex-wrap items-center gap-4">
      <div class="relative flex-grow md:flex-grow-0 w-full md:w-80">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
        </div>
        <input id="search" placeholder="통합 검색..." class="w-full rounded-lg bg-slate-800 border-slate-700 pl-10 pr-4 py-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
      </div>
      <select id="statusFilter" class="rounded-lg bg-slate-800 border-slate-700 px-4 py-2 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition">
        <option value="">상태 (전체)</option>
      </select>
      <div class="ml-auto flex items-center gap-3">
        <span class="text-slate-400 text-sm">선택: <b id="selCount">0</b></span>
        <button id="btnBulkStatus" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-700 hover:bg-sky-600 transition-colors">상태변경</button>
        <button id="btnBulkDelete" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-red-800 hover:bg-red-700 transition-colors">삭제</button>
        <button id="btnCsv" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-600 transition-colors">CSV</button>
      </div>
    </div>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th style="width:4%;">선택</th><th style="width:9%;">신청비번</th><th style="width:14%;">신청일</th>
            <th style="width:13%;">도장명</th><th style="width:9%;">관장명</th><th style="width:12%;">연락처</th>
            <th style="width:17%;">신청항목</th><th style="width:5%;" class="text-center">답변</th><th>주소</th>
            <th style="width:8%;" class="text-center">견적서</th><th style="width:9%;" class="text-center">상태</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="pagination-container" class="flex justify-center items-center gap-2 mt-4"></div>
  </main>

  <!-- STATS TAB -->
  <section id="statsTab" class="hidden container mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="p-4 rounded-xl border border-slate-700 bg-slate-800">
        <h3 class="font-bold mb-2">요약</h3>
        <div id="statsSummary" class="text-slate-300 text-sm space-y-1">-</div>
      </div>
      <div class="p-4 rounded-xl border border-slate-700 bg-slate-800 lg:col-span-2">
        <h3 class="font-bold mb-2">페이지 Top 10</h3>
        <canvas id="chartPage" height="120"></canvas>
      </div>
      <div class="p-4 rounded-xl border border-slate-700 bg-slate-800 lg:col-span-2">
        <h3 class="font-bold mb-2">국가 Top 10</h3>
        <canvas id="chartCountry" height="120"></canvas>
      </div>
      <div class="p-4 rounded-xl border border-slate-700 bg-slate-800">
        <h3 class="font-bold mb-2">최근 방문(최신 50)</h3>
        <div id="recentVisits" class="text-xs text-slate-300 max-h-[360px] overflow-auto space-y-2"></div>
      </div>
    </div>
  </section>
</div>

<script>
/* ====== CONFIG ====== */
const API_URL="https://script.google.com/macros/s/AKfycbxLE_foK3xXKDLDYQJ6c5iBnrGyeeVKiIXcTZedYLJa9212OKFwXmdADaqStV_2rSjj/exec";
const SESSION_STORAGE_KEY="spoband_admin_secret_session_pro";
const STATUS_OPTIONS=["신규","배송준비","배송중","배송완료","반품"];
const STATUS_COLORS={ "신규":"bg-sky-500","배송준비":"bg-amber-500","배송중":"bg-blue-500","배송완료":"bg-green-500","반품":"bg-red-500","default":"bg-slate-500" };

/* ====== STATE & HELPERS ====== */
const $=s=>document.querySelector(s);
let SECRET=null, ALL_POSTS=[], FILTERED_POSTS=[], currentPage=1, itemsPerPage=15;

const showLoading=(t="처리 중...")=>{$('#loading-text').textContent=t; $('#loading').classList.add('show');};
const hideLoading=()=>{$('#loading').classList.remove('show');};
const showError=msg=>{ const el=$('#errorMsg'); el.textContent=msg; el.classList.remove('hidden'); };
const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]) );

/* ====== API ====== */
async function adminCall(payload){
  try{
    const res=await fetch(API_URL,{method:"POST",headers:{'Content-Type':'text/plain'},body:JSON.stringify({...payload,secret:SECRET})});
    const txt=await res.text(); const j=JSON.parse(txt);
    if(!res.ok || j.status==='error') throw new Error(j.message||`HTTP ${res.status}`);
    return j.data||j; // {data:...} 또는 바로 데이터
  }catch(e){ showError("API 오류: "+(e.message||e)); throw e; }
}

/* ====== DATA LIST ====== */
async function refreshData(){
  const result=await adminCall({action:'adminList'});
  ALL_POSTS=(Array.isArray(result)?result:(result.data||[])).sort((a,b)=> (b.ts||0)-(a.ts||0));
  currentPage=1; applyFiltersAndRender();
}
function getStatusBadge(s){const c=STATUS_COLORS[s]||STATUS_COLORS.default; return `<span class="status-badge"><span class="status-dot ${c}"></span>${s||'N/A'}</span>`;}
function getFileBadge(url){return (url&&String(url).trim()!=="")?`<a href="${esc(url)}" target="_blank" class="status-badge"><span class="status-dot bg-emerald-500"></span>보기</a>`:`<span class="status-badge"><span class="status-dot bg-slate-500"></span>없음</span>`;}

function applyFiltersAndRender(){
  const q=$('#search').value.trim().toLowerCase(); const f=$('#statusFilter').value;
  FILTERED_POSTS=ALL_POSTS.filter(r=>(f? r.status===f : true) && (q? [r.id,r.dojo,r.master,r.contact,r.address,JSON.stringify(r.items)].some(v=>String(v||'').toLowerCase().includes(q)) : true));
  render();
}
function render(){
  const s=(currentPage-1)*itemsPerPage, e=s+itemsPerPage, list=FILTERED_POSTS.slice(s,e);
  $('#tbody').innerHTML=list.map(r=>{
    const itemsText=Object.entries(r.items||{}).map(([k,v])=>`${k.replace('sb','SB')}: ${v}개`).join(', ');
    return `<tr data-id="${esc(r.id)}">
      <td data-label="선택" class="text-center"><input type="checkbox" class="sel accent-sky-500 bg-slate-700 w-4 h-4" data-id="${esc(r.id)}"></td>
      <td data-label="신청비번">${esc(r.id)}</td>
      <td data-label="신청일">${new Date(r.ts).toLocaleString('ko-KR')}</td>
      <td data-label="도장명" title="${esc(r.dojo)}">${esc(r.dojo)}</td>
      <td data-label="관장명">${esc(r.master)}</td>
      <td data-label="연락처">${esc(r.contact)}</td>
      <td data-label="신청항목" title="${itemsText}">${itemsText}</td>
      <td data-label="답변" class="text-center">${(r.replies||[]).length}</td>
      <td data-label="주소" title="${esc(r.address)}">${esc(r.address)}</td>
      <td data-label="견적서" class="text-center">${getFileBadge(r.quotationUrl)}</td>
      <td data-label="상태" class="text-center">${getStatusBadge(r.status)}</td>
    </tr>`;
  }).join('');
  renderPagination(); updateSelCount();
}
function renderPagination(){
  const totalPages=Math.ceil(FILTERED_POSTS.length/itemsPerPage), c=$('#pagination-container');
  if(totalPages<=1){c.innerHTML='';return;}
  let h=`<button data-page="${currentPage-1}" class="px-3 py-1 rounded-md bg-slate-700 hover:bg-sky-600" ${currentPage===1?'disabled':''}>이전</button>`;
  let s=Math.max(1,currentPage-2), e=Math.min(totalPages,currentPage+2); if(currentPage<4)e=Math.min(5,totalPages); if(currentPage>totalPages-3)s=Math.max(1,totalPages-4);
  if(s>1){h+=`<button data-page="1" class="px-3 py-1 rounded-md bg-slate-700 hover:bg-sky-600">1</button>`; if(s>2)h+='<span class="px-3 py-1">...</span>';}
  for(let i=s;i<=e;i++) h+=`<button data-page="${i}" class="px-3 py-1 rounded-md ${i===currentPage?'bg-sky-600 font-bold':'bg-slate-700'} hover:bg-sky-600">${i}</button>`;
  if(e<totalPages){ if(e<totalPages-1)h+='<span class="px-3 py-1">...</span>'; h+=`<button data-page="${totalPages}" class="px-3 py-1 rounded-md bg-slate-700 hover:bg-sky-600">${totalPages}</button>`; }
  h+=`<button data-page="${currentPage+1}" class="px-3 py-1 rounded-md bg-slate-700 hover:bg-sky-600" ${currentPage===totalPages?'disabled':''}>다음</button>`;
  c.innerHTML=h;
}
function updateSelCount(){ $('#selCount').textContent=document.querySelectorAll('.sel:checked').length; }

/* ====== DETAIL MODAL ====== */
function openModal(id) {
  const post = ALL_POSTS.find(p => String(p.id) === String(id));
  if (!post) return;

  const itemsHtml = Object.entries(post.items || {})
    .map(([k, v]) => `
      <div class="flex justify-between py-1">
        <span class="text-slate-400">${k.replace('sb','SB')}</span>
        <span class="font-semibold">${v} 개</span>
      </div>
    `).join('');

  const repliesHtml = (post.replies || []).length > 0
    ? post.replies.map(r => `
        <div class="mt-2 p-3 bg-slate-900 rounded-lg">
          <div class="flex justify-between items-center text-xs text-slate-400 mb-1">
            <span>${esc(r.author || '관리자')}</span>
            <span>${new Date(r.ts).toLocaleString('ko-KR')}</span>
          </div>
          <p class="text-sm whitespace-pre-wrap">${esc(r.content)}</p>
        </div>
      `).join('')
    : '<p class="text-slate-400 text-sm">등록된 답변이 없습니다.</p>';

  $('#modal-content').innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
      <div class="md:col-span-2 p-4 bg-slate-900 rounded-lg">
        <h4 class="text-base font-bold mb-3 text-slate-300">신청 정보</h4>
        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
          <div><strong class="text-slate-400 inline-block w-20">신청비번:</strong> ${esc(post.id)}</div>
          <div><strong class="text-slate-400 inline-block w-20">상태:</strong> ${getStatusBadge(post.status)}</div>
          <div><strong class="text-slate-400 inline-block w-20">신청일:</strong> ${new Date(post.ts).toLocaleString('ko-KR')}</div>
          <div><strong class="text-slate-400 inline-block w-20">연락처:</strong> ${esc(post.contact)}</div>
          <div><strong class="text-slate-400 inline-block w-20">도장명:</strong> ${esc(post.dojo)}</div>
          <div><strong class="text-slate-400 inline-block w-20">관장명:</strong> ${esc(post.master)}</div>
          <div class="col-span-2"><strong class="text-slate-400 inline-block w-20">주소:</strong> ${esc(post.address)}</div>
          <div class="col-span-2">
            <strong class="text-slate-400 inline-block w-20">견적서:</strong>
            ${post.quotationUrl
              ? `<a href="${esc(post.quotationUrl)}" target="_blank" class="text-sky-400 hover:underline break-all">보기</a>`
              : '없음'}
          </div>
        </div>
      </div>

      <div>
        <h4 class="text-base font-bold mb-2 p-3 bg-slate-900 rounded-t-lg text-slate-300">신청 항목</h4>
        <div class="p-4 bg-slate-900 rounded-b-lg">${itemsHtml || '<span class="text-slate-400">없음</span>'}</div>
      </div>

      <div>
        <h4 class="text-base font-bold mb-2 p-3 bg-slate-900 rounded-t-lg text-slate-300">답변 내역</h4>
        <div class="p-4 bg-slate-900 rounded-b-lg max-h-48 overflow-y-auto">${repliesHtml}</div>
      </div>
    </div>
  `;

  $('#modal-actions').innerHTML = `
    <form id="modal-reply-form" class="flex gap-2 items-start mb-4" data-id="${esc(post.id)}">
      <textarea name="content" class="flex-grow rounded-lg bg-slate-700 border-slate-600 p-2 text-sm focus:ring-sky-500 transition" placeholder="답변을 입력하세요..." rows="2"></textarea>
      <button type="submit" class="px-4 py-2 text-sm rounded-lg bg-sky-600 hover:bg-sky-700 transition-colors h-full">답변 등록</button>
    </form>
    <form id="modal-upload-form" class="flex gap-2 items-center" data-id="${esc(post.id)}">
      <label class="block flex-grow">
        <span class="sr-only">Choose file</span>
        <input type="file" name="file" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200 transition"/>
      </label>
      <button type="submit" class="px-4 py-2 text-sm rounded-lg bg-slate-600 hover:bg-slate-500 transition-colors">견적서 업로드</button>
    </form>
  `;

  // 폼 이벤트 (답변/업로드) 한번만 바인딩
  const actions = $('#modal-actions');
  actions.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const pid  = form.dataset.id;

    if (form.id === 'modal-reply-form') {
      const content = form.elements.content.value.trim();
      if (!content) return;
      try {
        await adminCall({ action: 'addReply', id: pid, reply: { content, ts: Date.now(), author: '관리자' } });
        await refreshData();
        openModal(pid); // 갱신 재표시
      } catch (_) {}
    }

    if (form.id === 'modal-upload-form') {
      const file = form.elements.file.files[0];
      if (!file) { alert('파일을 선택해주세요.'); return; }
      const fr = new FileReader();
      fr.onload = async ev => {
        const [, data] = String(ev.target.result).split(',');
        try {
          await adminCall({ action: 'uploadFile', id: pid, fileName: file.name, mimeType: file.type, data });
          await refreshData();
          openModal(pid);
        } catch (_) {}
      };
      fr.readAsDataURL(file);
    }
  }, { once: true });

  $('#detail-modal').classList.add('show');
}
function closeModal(){ $('#detail-modal').classList.remove('show'); }

/* ====== VISIT STATS ====== */
async function loadStats(){
  showLoading("통계 불러오는 중...");
  try{
    const stats = await adminCall({action:'visitStats'});
    const recent = await adminCall({action:'visitRecent', limit:50}).catch(()=>({items:[]}));
    renderStats(stats, recent.items||recent.data||[]);
  }finally{ hideLoading(); }
}
function renderStats(stats, recent){
  const sum = stats.totals||{enter:0,leave:0,users:0};
  $('#statsSummary').innerHTML = `
    <div>방문수(enter): <b>${sum.enter.toLocaleString()}</b></div>
    <div>이탈수(leave): <b>${sum.leave.toLocaleString()}</b></div>
    <div>순사용자(UID 기준): <b>${sum.users.toLocaleString()}</b></div>
  `;
  function mkBar(canvasSel, items, label){
    const ctx=$(canvasSel).getContext('2d');
    const labels=(items||[]).slice(0,10).map(x=>Array.isArray(x)?x[0]:x.label||'');
    const data  =(items||[]).slice(0,10).map(x=>Array.isArray(x)?x[1]:x.count||0);
    new Chart(ctx,{type:'bar',
      data:{labels,datasets:[{label,data}]},
      options:{responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#cbd5e1'}}, y:{ticks:{color:'#cbd5e1'}}}}
    });
  }
  mkBar('#chartPage',    stats.byPage||[],    '페이지');
  mkBar('#chartCountry', stats.byCountry||[], '국가');

  $('#recentVisits').innerHTML = (recent||[]).map(v=>`
    <div class="border border-slate-700 rounded-md p-2">
      <div class="flex justify-between text-slate-400"><span>${new Date(v.ts).toLocaleString('ko-KR')}</span><span>${v.type||''}</span></div>
      <div class="mt-1">${(v.country||"미상")} ${v.city?("· "+v.city):""}</div>
      <div class="text-slate-400 truncate">${v.page||''}</div>
      <div class="text-slate-500 truncate text-[11px]">${v.ip||""} ${v.org?("· "+v.org):""}</div>
    </div>`).join('');
}

/* ====== EVENTS ====== */
function setupAppEventListeners(){
  $('#btnReload').addEventListener('click', async ()=>{
    if($('#dataTab').classList.contains('hidden')) await loadStats(); else await refreshData();
  });
  $('#btnLogout').addEventListener('click', ()=>{ if(confirm('로그아웃 하시겠습니까?')){ sessionStorage.removeItem(SESSION_STORAGE_KEY); location.reload(); } });

  // 탭 전환
  $('#btnDataTab').addEventListener('click', async ()=>{
    $('#btnDataTab').classList.add('active'); $('#btnStatsTab').classList.remove('active');
    $('#dataTab').classList.remove('hidden'); $('#statsTab').classList.add('hidden');
    await refreshData();
  });
  $('#btnStatsTab').addEventListener('click', async ()=>{
    $('#btnStatsTab').classList.add('active'); $('#btnDataTab').classList.remove('active');
    $('#statsTab').classList.remove('hidden'); $('#dataTab').classList.add('hidden');
    await loadStats();
  });

  // 검색/필터/페이지
  $('#search').addEventListener('input', ()=>{ currentPage=1; applyFiltersAndRender(); });
  $('#statusFilter').addEventListener('change', ()=>{ currentPage=1; applyFiltersAndRender(); });
  $('#tbody').addEventListener('change', e=>{ if(e.target.classList.contains('sel')) updateSelCount(); });
  $('#pagination-container').addEventListener('click', e=>{ if(e.target.tagName==='BUTTON' && e.target.dataset.page){ currentPage=parseInt(e.target.dataset.page,10); render(); } });

  // 행 클릭 → 모달
  $('#tbody').addEventListener('click', (e) => {
    if (e.target.closest('input[type="checkbox"]')) return;
    const tr = e.target.closest('tr');
    if (tr?.dataset.id) openModal(tr.dataset.id);
  });

  // 모달 닫기
  document.getElementById('modal-close-btn').addEventListener('click', closeModal);
  document.getElementById('modal-backdrop').addEventListener('click', closeModal);
  document.addEventListener('keydown', e => { if (e.key === "Escape") closeModal(); });
}

/* ====== INIT ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  const sf=$('#statusFilter'); STATUS_OPTIONS.forEach(o=> sf.innerHTML+=`<option value="${o}">${o}</option>`);

  $('#login-form').addEventListener('submit', async e=>{
    e.preventDefault(); $('#login-error').textContent='';
    SECRET=$('#password-input').value; if(!SECRET) return;
    try{ await adminCall({action:'authCheck'}); sessionStorage.setItem(SESSION_STORAGE_KEY, SECRET);
      $('#login-wall').classList.remove('show'); $('#app-container').classList.remove('hidden');
      setupAppEventListeners(); await refreshData();
    }catch{ $('#login-error').textContent='비밀키가 유효하지 않습니다.'; }
  });

  const ss=sessionStorage.getItem(SESSION_STORAGE_KEY);
  if(ss){ $('#password-input').value=ss; $('#login-form').dispatchEvent(new Event('submit')); }
});
</script>

<!-- Toast container (옵션: 필요시 사용) -->
<div id="toast-root" class="pointer-events-none fixed bottom-4 right-4 z-[9999] space-y-2"></div>

</body>
</html>
