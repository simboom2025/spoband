<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SPOBAND Admin (Grid)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
  .container-narrow{max-width:1200px}
  /* ── 엑셀 그리드 스타일 ───────────────────────── */
  .grid-wrap{border-radius:16px;overflow:auto;border:1px solid #1f2937;background:#0f172a}
  table.grid{width:100%;border-collapse:separate;border-spacing:0;min-width:1200px}
  .grid thead th{
    position:sticky;top:0;z-index:1;background:#0b1220;color:#cbd5e1;font-weight:700;
    border-bottom:1px solid #1f2937; padding:10px 12px; text-align:left; white-space:nowrap;
  }
  .grid tbody td{padding:10px 12px;border-bottom:1px solid #1f2937;color:#e2e8f0}
  .grid tbody tr:nth-child(even){background:#0b1220}
  .grid tbody tr:hover{background:#122137}
  .grid .col-idx{width:60px;color:#94a3b8}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #334155;border-radius:12px;padding:.15rem .5rem;font-size:12px;color:#94a3b8}
  .btn{border-radius:10px;padding:.4rem .75rem;font-weight:700; transition: background-color 0.2s;}
  .btn-ghost{background:#1f2937;color:#cbd5e1}
  .btn-ghost:hover{background:#374151}
  .btn-blue{background:#0ea5e9;color:white}
  .btn-blue:hover{background:#0284c7}
  .btn-green{background:#10b981;color:white}
  .btn-green:hover{background:#059669}
  .btn-red{background:#ef4444;color:white}
  .btn-red:hover{background:#dc2626}
  /* 모달 */
  .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,.75);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
  .modal-bg.show{display:flex}
</style>
</head>
<body class="bg-slate-900 text-white">
<header class="sticky top-0 z-40 bg-slate-950/70 border-b border-slate-800 backdrop-blur">
  <div class="container-narrow mx-auto h-16 px-4 flex items-center justify-between">
    <h1 class="text-xl font-black">SPOBAND <span class="text-sky-400">Admin</span></h1>
    <div class="flex items-center gap-3">
      <a href="index.html" class="btn btn-ghost">사이트 보기</a>
      <button id="btnLogout" class="btn btn-ghost">로그아웃</button>
    </div>
  </div>
</header>

<main class="container-narrow mx-auto px-4 py-6">
  <div class="flex items-center gap-3 flex-wrap">
    <input id="q" class="w-[min(680px,100%)] px-4 py-2 rounded-xl bg-slate-900/60 border border-slate-700" placeholder="검색: 도장/관장/연락처/주소" />
    <button id="btnReload" class="btn btn-ghost">새로고침</button>
    <button id="btnDeleteAll" class="btn btn-red">전체삭제</button>
    <span id="counter" class="ml-auto text-slate-400"></span>
  </div>

  <div class="grid-wrap mt-4">
    <table class="grid" id="grid">
      <thead>
        <tr>
          <th class="col-idx">#</th>
          <th>연락처</th>
          <th>주소(도장명)</th>
          <th>신청일</th>
          <th>견적서</th>
          <th style="width:280px">작업</th>
        </tr>
      </thead>
      <tbody id="tbody">
        </tbody>
    </table>
  </div>
</main>

<div id="mdDetails" class="modal-bg">
  <div class="w-[min(860px,92vw)] bg-slate-800 rounded-2xl border border-slate-700 p-4">
    <div class="flex items-center justify-between border-b border-slate-700 pb-2">
      <h3 class="font-bold">신청 상세</h3>
      <button class="btn btn-ghost" onclick="closeModal('mdDetails')">닫기</button>
    </div>
    <div id="detailsBody" class="mt-3 text-sm grid gap-2"></div>
  </div>
</div>

<div id="mdReply" class="modal-bg">
  <div class="w-[min(720px,92vw)] bg-slate-800 rounded-2xl border border-slate-700 p-4">
    <div class="flex items-center justify-between border-b border-slate-700 pb-2">
      <h3 class="font-bold">관리자 답변 작성</h3>
      <button class="btn btn-ghost" onclick="closeModal('mdReply')">닫기</button>
    </div>
    <textarea id="replyInput" rows="7" class="w-full mt-3 px-3 py-2 rounded-xl bg-slate-900/60 border border-slate-700" placeholder="답변 내용을 입력하세요."></textarea>
    <div class="mt-3 text-right">
      <button id="btnReplySend" class="btn btn-blue">등록</button>
    </div>
  </div>
</div>

<div id="mdUpload" class="modal-bg">
  <div class="w-[min(720px,92vw)] bg-slate-800 rounded-2xl border border-slate-700 p-4">
    <div class="flex items-center justify-between border-b border-slate-700 pb-2">
      <h3 class="font-bold">견적서 업로드</h3>
      <button class="btn btn-ghost" onclick="closeModal('mdUpload')">닫기</button>
    </div>
    <div class="mt-3 space-y-3">
      <input id="fileInput" type="file" class="block w-full text-sm" />
      <p class="text-slate-400 text-sm">PDF 권장 (이미지/오피스 문서도 가능)</p>
    </div>
    <div class="mt-3 text-right">
      <button id="btnUploadGo" class="btn btn-green">업로드</button>
    </div>
  </div>
</div>

<script>
/* ================== 환경 ================== */
// ❗❗❗ IMPORTANT: Replace this URL with your deployed Google Apps Script URL
const API_URL = "https://script.google.com/macros/s/AKfycbwJIXRV0e0QRBIaYrwsJv5c5Rsht-HgrFARht9kiriOkdBXn0wkGdQnR3cZr3pnbNmK/exec";
const ADMIN_SECRET = localStorage.getItem("ADMIN_SECRET") || "";
let POSTS = []; // 전체 목록 캐시
let currentIdForReply = null;
let currentIdForUpload = null;

/* ============= 유틸 ============= */
const $ = (s, el=document)=>el.querySelector(s);
const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
const fmt = ts => ts ? new Date(Number(ts)).toLocaleString() : "";
const esc = s => String(s||"")
  .replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))

function alertErr(e){ alert("오류: " + (e?.message || e)); }
function openModal(id){ $("#"+id).classList.add("show"); }
function closeModal(id){ $("#"+id).classList.remove("show"); }

/* ============= 데이터 로딩/그리기 ============= */
async function fetchList(){
  try {
    const res = await fetch(`${API_URL}?action=list`);
    if(!res.ok) throw new Error("목록 불러오기 실패 (HTTP " + res.status + ")");
    const data = await res.json();
    POSTS = Array.isArray(data)? data : [];
    renderGrid(POSTS);
  } catch(e) {
    alertErr(e);
  }
}

function renderGrid(rows){
  const q = $("#q").value.trim();
  const list = q ? rows.filter(r=>{
    const hay = `${r.contact} ${r.dojo} ${r.master} ${r.address}`.toLowerCase();
    return hay.includes(q.toLowerCase());
  }) : rows;

  $("#counter").textContent = `총 ${list.length}건`;
  $("#tbody").innerHTML = list.map((r, i)=>`
    <tr>
      <td class="col-idx">${i+1}</td>
      <td>
        <div class="font-semibold">${esc(r.contact||"")}</div>
        <div class="text-slate-400 text-xs">${esc(r.master||"")}</div>
      </td>
      <td>
        <div class="font-semibold">${esc(r.dojo||"")}</div>
        <div class="text-slate-400 text-xs">${esc(r.address||"")}</div>
      </td>
      <td><span class="badge">${r.ts?fmt(r.ts):"없음"}</span></td>
      <td>
        ${
          r.quotationUrl
            ? `<a href="${esc(r.quotationUrl)}" target="_blank" class="text-sky-400 underline hover:text-sky-300">다운로드</a>`
            : `<span class="badge">없음</span>`
        }
      </td>
      <td>
        <div class="flex gap-2">
          <button class="btn btn-ghost" onclick="onDetails('${r.id}')">상세</button>
          <button class="btn btn-blue" onclick="onReply('${r.id}')">답변</button>
          <button class="btn btn-green" onclick="onUpload('${r.id}')">견적 업로드</button>
          <button class="btn btn-red" onclick="onDelete('${r.id}')">삭제</button>
        </div>
      </td>
    </tr>
  `).join("");
}

/* ============= 동작 ============= */
async function onDetails(id){
  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ action:"getPost", id, secret: ADMIN_SECRET })
    });
    const json = await res.json();
    if(json.status!=="success") throw new Error(json.message||"상세 정보 로딩 실패");

    const p = json.data||{};
    $("#detailsBody").innerHTML = `
      <div><b>도장명:</b> ${esc(p.dojo)}</div>
      <div><b>관장:</b> ${esc(p.master)}</div>
      <div><b>연락처:</b> ${esc(p.contact)}</div>
      <div><b>주소:</b> ${esc(p.address)}</div>
      <div><b>신청일:</b> ${fmt(p.ts)}</div>
      <div><b>견적서:</b> ${p.quotationUrl? `<a class="text-sky-400 underline" target="_blank" href="${esc(p.quotationUrl)}">다운로드</a>`:'<span class="badge">없음</span>'}</div>
      <hr class="border-slate-700 my-2">
      <div><b>신청 항목:</b></div>
      <pre class="bg-slate-900/60 border border-slate-700 rounded-xl p-2 mt-1 text-xs whitespace-pre-wrap">${esc(JSON.stringify(p.items||{}, null, 2))}</pre>
      <div class="mt-3"><b>관리자 답변:</b></div>
      <div class="mt-1 space-y-2">
        ${ (p.replies||[]).map(r=>`
          <div class="p-2 bg-slate-900/60 border border-slate-700 rounded-lg">
            <div class="text-sm">${esc(r.content)}</div>
            <div class="text-xs text-slate-400 text-right">${fmt(r.ts)}</div>
          </div>`).join('') || '<div class="text-slate-400 text-sm">없음</div>'}
      </div>
    `;
    openModal('mdDetails');
  }catch(e){ alertErr(e); }
}

function onReply(id){
  currentIdForReply = id;
  $("#replyInput").value = "";
  openModal('mdReply');
}

async function sendReply(){
  if(!currentIdForReply) return;
  const content = $("#replyInput").value.trim();
  if(!content){ alert("내용을 입력하세요."); return; }
  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ action:"addReply", id: currentIdForReply, content, secret: ADMIN_SECRET })
    });
    const json = await res.json();
    if(json.status!=="success") throw new Error(json.message||"답변 등록 실패");
    closeModal('mdReply');
    await fetchList();
  }catch(e){ alertErr(e); }
}

function onUpload(id){
  currentIdForUpload = id;
  $("#fileInput").value = "";
  openModal('mdUpload');
}

async function goUpload(){
  if(!currentIdForUpload) return;
  const f = $("#fileInput").files[0];
  if(!f){ alert("파일을 선택하세요."); return; }
  try{
    const b64 = await new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=>resolve(String(fr.result).split(",")[1]||"");
      fr.onerror = reject;
      fr.readAsDataURL(f);
    });

    const payload = {
      action:"uploadQuotation",
      id: currentIdForUpload,
      filename: f.name,
      mime: f.type || "application/octet-stream",
      data: b64,
      secret: ADMIN_SECRET
    };

    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if(json.status!=="success") throw new Error(json.message||"업로드 실패");
    closeModal('mdUpload');
    await fetchList();
  }catch(e){ alertErr(e); }
}

async function onDelete(id){
  if(!confirm("정말 삭제하시겠습니까? 데이터는 복구할 수 없습니다.")) return;
  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ action:"delete", id, secret: ADMIN_SECRET })
    });
    const json = await res.json();
    if(json.status!=="success") throw new Error(json.message||"삭제 실패");
    await fetchList();
  }catch(e){ alertErr(e); }
}

/* ============= 이벤트 바인딩 ============= */
$("#btnReload").addEventListener("click", fetchList);
$("#btnDeleteAll").addEventListener("click", async ()=>{
  if(!confirm("정말 전체 삭제하시겠습니까? 모든 데이터가 영구적으로 삭제됩니다.")) return;
  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({ action:"deleteAll", secret: ADMIN_SECRET })
    });
    const json = await res.json();
    if(json.status!=="success") throw new Error(json.message||"전체 삭제 실패");
    await fetchList();
  }catch(e){ alertErr(e); }
});
$("#q").addEventListener("input", ()=>renderGrid(POSTS));
$("#btnReplySend").addEventListener("click", sendReply);
$("#btnUploadGo").addEventListener("click", goUpload);
$("#btnLogout").addEventListener("click", () => {
  if(confirm("로그아웃 하시겠습니까?")) {
    localStorage.removeItem("ADMIN_SECRET");
    alert("로그아웃 되었습니다. 페이지를 새로고침합니다.");
    location.reload();
  }
});

/* 초기 로드 */
if (!ADMIN_SECRET) {
  const secret = prompt("관리자 비밀키를 입력하세요:");
  if(secret) {
    localStorage.setItem("ADMIN_SECRET", secret);
    location.reload();
  } else {
    document.body.innerHTML = `<div class="text-center p-8">관리자 키가 없어 페이지를 표시할 수 없습니다.</div>`;
  }
} else {
  fetchList().catch(alertErr);
}
</script>
</body>
</html>