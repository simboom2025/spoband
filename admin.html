<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPOBAND 주문 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;}
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid #4A5568; padding: 10px; text-align: left; word-break: break-all; }
        th { background-color: #2D3748; }
        select { background-color: #1A202C; border: 1px solid #4A5568; color: white; padding: 5px; border-radius: 5px;}
        .status-신규.접수 { background-color: #c6f6d5; color: #2f855a; }
        .status-입금.확인 { background-color: #bee3f8; color: #2b6cb0; }
        .status-배송.중 { background-color: #faf089; color: #b7791f; }
        .status-배송.완료 { background-color: #e2e8f0; color: #1a202c; }
        .status-주문.취소 { background-color: #fed7d7; color: #c53030; }
    </style>
</head>
<body class="bg-slate-900 text-white p-8">

    <div id="dashboard" class="hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">주문 관리 대시보드</h1>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">로그아웃</button>
        </div>
        <div id="order-list" class="overflow-x-auto">
            <p>주문 목록을 불러오는 중...</p>
        </div>
    </div>

<script>
    const $ = (s, el = document) => el.querySelector(s);
    const API_URL = "https://script.google.com/macros/s/AKfycbxA_Q-ELqpvKY0Di_bw3SDgOieBdRFvxhpAhQQc8BqKfl3eV4tNmo8A1fquqtHWhu53Pw/exec";

    function showDashboard() {
        const password = sessionStorage.getItem('adminPassword');
        if (!password) {
            showLogin();
            return;
        }

        $('#dashboard').classList.remove('hidden');

        const statusOptions = ["신규 접수", "입금 확인", "배송 중", "배송 완료", "주문 취소"];

        const loadAdminOrders = async () => {
            try {
                $('#order-list').innerHTML = '<p>주문 목록을 불러오는 중...</p>';
                const res = await fetch(`${API_URL}?action=list&adminPassword=${password}`);
                if (!res.ok) throw new Error('관리자 데이터를 불러오는 데 실패했습니다.');
                const orders = await res.json();
                
                if (!orders.length) {
                    $('#order-list').innerHTML = '<p>아직 접수된 주문이 없습니다.</p>';
                    return;
                }
                
                const tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%;">신청일</th>
                                <th style="width: 10%;">도장명</th>
                                <th style="width: 8%;">관장님</th>
                                <th style="width: 12%;">연락처</th>
                                <th style="width: 20%;">주소</th>
                                <th style="width: 25%;">주문내역</th>
                                <th style="width: 10%;">상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td>${new Date(order.ts).toLocaleString()}</td>
                                    <td>${order.dojo}</td>
                                    <td>${order.master}</td>
                                    <td>${order.contact}</td>
                                    <td>${order.address}</td>
                                    <td>${Object.entries(order.items || {}).filter(([,v]) => v > 0).map(([k,v]) => `${k.replace('q_','').toUpperCase()}: ${v}개`).join('<br>')}</td>
                                    <td>
                                        <select data-id="${order.id}" class="status-select">
                                            ${statusOptions.map(s => `<option value="${s}" ${s === order.status ? 'selected' : ''}>${s}</option>`).join('')}
                                        </select>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
                $('#order-list').innerHTML = tableHTML;
            } catch (err) {
                alert(err.message);
                $('#order-list').innerHTML = '<p>오류 발생: ' + err.message + '</p>';
            }
        };
        
        $('#order-list').addEventListener('change', async (e) => {
            if (e.target.classList.contains('status-select')) {
                const id = e.target.dataset.id;
                const status = e.target.value;
                const originalColor = e.target.style.backgroundColor;
                e.target.disabled = true;

                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'updateStatus', id, status, adminPassword: password })
                    });
                    if (!res.ok) throw new Error('상태 업데이트 실패');
                    const result = await res.json();
                    if (result.status === 'success') {
                        e.target.style.backgroundColor = 'green';
                        setTimeout(() => { e.target.style.backgroundColor = originalColor; }, 1500);
                    } else {
                        throw new Error(result.message);
                    }
                } catch (err) {
                    alert('오류: ' + err.message);
                    loadAdminOrders();
                } finally {
                    e.target.disabled = false;
                }
            }
        });
        
        loadAdminOrders();
    }

    function showLogin() {
        const password = prompt("관리자 비밀번호를 입력하세요 (초기: 1234).");
        if (password) {
            // 간단한 비밀번호 검증 후 세션에 저장.
            // 실제 서비스에서는 백엔드에서 비밀번호를 검증해야 합니다.
            sessionStorage.setItem('adminPassword', password);
            showDashboard();
        }
    }

    function logout() {
        sessionStorage.removeItem('adminPassword');
        window.location.reload();
    }

    document.addEventListener('DOMContentLoaded', () => {
        $('#logout-btn')?.addEventListener('click', logout);

        if (sessionStorage.getItem('adminPassword')) {
            showDashboard();
        } else {
            showLogin();
        }
    });
</script>

</body>
</html>