<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>관리자 대시보드</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body { max-width: 980px; }
    iframe { max-width: 100%; border-radius: 12px; }
  </style>

  <script type="module">
    // 1) Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 2) 네 프로젝트 설정 (spoband-e41fe)
    const firebaseConfig = {
      apiKey: "AIzaSyAcSrJ6wyjk1lNraj0uZY6JofoSpAo1hrQ",
      authDomain: "spoband-e41fe.firebaseapp.com",
      projectId: "spoband-e41fe",
      storageBucket: "spoband-e41fe.firebasestorage.app",
      messagingSenderId: "203803760756",
      appId: "1:203803760756:web:d32d2c1d1e272035d91921"
    };

    // 3) 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 유튜브 URL 자동 변환 (watch → embed)
    function toEmbedUrl(url) {
      if (!url) return "";
      // https://youtu.be/abcd → embed
      url = url.replace("youtu.be/", "www.youtube.com/watch?v=");
      // https://www.youtube.com/watch?v=abcd → embed
      return url.replace("watch?v=", "embed/");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const $ = (sel) => document.querySelector(sel);
      const loginStatus = $("#loginStatus");

      // 로그인/로그아웃
      $("#loginBtn").addEventListener("click", async () => {
        const email = $("#email").value.trim();
        const pw = $("#password").value.trim();
        try {
          await signInWithEmailAndPassword(auth, email, pw);
          loginStatus.textContent = "관리자 로그인: " + email;
        } catch (e) {
          alert("로그인 실패: " + e.message);
        }
      });

      $("#logoutBtn").addEventListener("click", async () => {
        await signOut(auth);
        loginStatus.textContent = "로그인 상태: 없음";
      });

      // 상품 추가
      $("#addProductBtn").addEventListener("click", async () => {
        const name = $("#pname").value.trim();
        const price = parseInt($("#pprice").value.trim() || "0", 10);
        const link = $("#plink").value.trim();
        const desc = $("#pdesc").value.trim();
        if (!name) return alert("상품명을 입력하세요.");
        await addDoc(collection(db, "products"), { name, price, link, desc });
        alert("상품 추가 완료!");
        location.reload();
      });

      // 영상 추가 (URL 자동 변환)
      $("#addVideoBtn").addEventListener("click", async () => {
        const title = $("#vtitle").value.trim();
        const category = $("#vcategory").value.trim();
        let url = $("#vurl").value.trim();
        const desc = $("#vdesc").value.trim();
        if (!title) return alert("영상 제목을 입력하세요.");
        url = toEmbedUrl(url);
        await addDoc(collection(db, "videos"), { title, category, url, desc });
        alert("영상 추가 완료!");
        location.reload();
      });

      // 상품 목록 로드
      const pTbody = $("#productTable");
      const pSnap = await getDocs(collection(db, "products"));
      pSnap.forEach((d) => {
        const x = d.data();
        pTbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${x.name || ""}</td>
            <td>${(x.price || 0).toLocaleString()}원</td>
            <td>${x.link ? `<a href="${x.link}" target="_blank" class="btn btn-sm btn-outline-primary">열기</a>` : ""}</td>
            <td>${x.desc || ""}</td>
            <td><button class="btn btn-sm btn-danger" onclick="__delP('${d.id}')">삭제</button></td>
          </tr>
        `);
      });

      // 영상 목록 로드
      const vTbody = $("#videoTable");
      const vSnap = await getDocs(collection(db, "videos"));
      vSnap.forEach((d) => {
        const x = d.data();
        vTbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${x.title || ""}</td>
            <td>${x.category || ""}</td>
            <td>${x.url ? `<a href="${x.url}" target="_blank" class="btn btn-sm btn-outline-primary">열기</a>` : ""}</td>
            <td>${x.desc || ""}</td>
            <td><button class="btn btn-sm btn-danger" onclick="__delV('${d.id}')">삭제</button></td>
          </tr>
        `);
      });

      // 전역 삭제 함수
      window.__delP = async (id) => {
        await deleteDoc(doc(db, "products", id));
        alert("삭제 완료");
        location.reload();
      };
      window.__delV = async (id) => {
        await deleteDoc(doc(db, "videos", id));
        alert("삭제 완료");
        location.reload();
      };
    });
  </script>
</head>

<body class="container my-4">
  <h2 class="mb-3">관리자 대시보드</h2>

  <div class="card p-3 mb-4">
    <div class="row g-2">
      <div class="col-sm">
        <input id="email" class="form-control" placeholder="관리자 이메일" />
      </div>
      <div class="col-sm">
        <input id="password" type="password" class="form-control" placeholder="비밀번호" />
      </div>
      <div class="col-auto d-flex gap-2">
        <button id="loginBtn" class="btn btn-primary">로그인</button>
        <button id="logoutBtn" class="btn btn-secondary">로그아웃</button>
      </div>
    </div>
    <div class="text-muted mt-2" id="loginStatus">로그인 상태: 없음</div>
  </div>

  <h4 class="mt-4">상품 관리</h4>
  <div class="input-group mb-3">
    <input id="pname" class="form-control" placeholder="상품명" />
    <input id="pprice" type="number" class="form-control" placeholder="가격(숫자)" />
    <input id="plink" class="form-control" placeholder="구매 링크(URL)" />
    <input id="pdesc" class="form-control" placeholder="설명" />
    <button id="addProductBtn" class="btn btn-success">상품 추가</button>
  </div>
  <table class="table table-bordered">
    <thead class="table-light">
      <tr><th>상품명</th><th>가격</th><th>링크</th><th>설명</th><th>삭제</th></tr>
    </thead>
    <tbody id="productTable"></tbody>
  </table>

  <h4 class="mt-5">영상 관리</h4>
  <div class="input-group mb-3">
    <input id="vtitle" class="form-control" placeholder="영상 제목" />
    <input id="vcategory" class="form-control" placeholder="카테고리(예: 초보/다이어트/재활)" />
    <input id="vurl" class="form-control" placeholder="YouTube URL(자동 embed 변환)" />
    <input id="vdesc" class="form-control" placeholder="설명" />
    <button id="addVideoBtn" class="btn btn-success">영상 추가</button>
  </div>
  <table class="table table-bordered">
    <thead class="table-light">
      <tr><th>제목</th><th>카테고리</th><th>URL</th><th>설명</th><th>삭제</th></tr>
    </thead>
    <tbody id="videoTable"></tbody>
  </table>
</body>
</html>
